# Methods

## British Columbia's flatfish fishery

British Columbia's multi-species complex of 
right-eyed flounders is a technically interacting 
group of flatfishes managed across the whole
BC coast. Although there are several right-eyed 
flounders in BC waters, we focus on Dover sole 
(*Microstomus pacficus*), English sole 
(*Parophrys vetulus*), and southern rock sole (*Lepidopsetta 
bilineata*), which we refer to hereafter as rock 
sole. Taken together, we denote the Dover, English and rock sole 
multi-stock complex as the DER complex. We chose this DER complex
because harvesting is managed as part of the BC 
multi-species groundfish fishery, all three species have 
the same management unit boundaries, and individual
species are targeted at different times of the year by 
the same commercial bottom trawl fleet. 

The DER complex is managed in three spatially distinct stock
areas (Figure 1), which line up with aggregates 
of BC groundfish management areas [@PRIFMP2015]. 
From North to South, the first 
stock area extends from Dixon Entrance, north of Haida Gwaii, 
south through Hecate Strait; we refer to it as the Hecate Strait/Haida 
Gwaii (HSHG) stock, and it corresponds to BC groundfish 
area 5CDE. The second stock area is Queen Charlotte Sound 
(QCS), or BC groundfish area 5AB. Finally, the third
area extends along the West Coast of Vancouver Island (WCVI) 
from its northern tip down to the entrance to Juan de Fuca Strait,
and corresponds to BC groundfish area 3CD.

All stocks had at least three indices of biomass
over the course of the historical period. There
were two commercial fishery dependant catch-per-
unit-of-effort (CPUE) indices spanning 1976 - 2016, 
split between a historical trawl fishery (1976 - 1995) 
and a modern trawl fishery (1995 - 2016), corresponding 
to pre-and post-implementation of an at-sea-observer 
program, as well as differences in CPUE standardisation. 
The fishery independent trawl survey biomass indices 
were the Hecate Strait Assemblage survey, a biennial 
survey in areas 5C and 5D (1984 - 2002), and the 
Groundfish Multi-species Synoptic Survey, with 
biennial legs in all groundfish management 
areas (2003 - 2016).

Although the DER complex has been exploited since 
at least 1956, at that time Dover sole was only 
lightly exploited, with full commercial exploitation
beginning only in the 1970s (Fig. 1, first column). 
In contrast, English and rock sole fisheries have been 
very active since 1956 in the HSHG area since, where the 
largest biomass is concentrated for both species. In 
contrast English and rock sole fishing activity 
in QCS and WCVI areas is more variable 
over time (Figure 1, rows 2 and 3).

Despite a long history of explotitation, and in some cases
recovery from near collapse, most DER complex stocks were 
in a relatively healthy state by 2016, with current spawning
biomasses above 80% of $B_{MSY}$, and all but three cases 
at or above $B_{MSY}$ (Table 1). Moreover, some stocks 
were actively recovering from their historic low biomasses, 
like English sole in HSHG, and Rock sole in HSHG and WCVI.



## Closed loop simulation framework

Our simulation framework had a stochastic operating
model component and an assessment model component. The
operating model simulated population dynamics 
of a spatially stratified, multi-species flatfish complex
in response to a multi-species trawl fishery in each of 
the three stock areas. Although total fishing effort 
was not restricted across the entire area, effort 
in each individual area was allocated such that
no species-/area-specific catch exceeded the 
species-/area-specific TAC. Within an area,
fishing effort was allowed to increase until at least
one species-/area-specific TAC was fully caught.

Closed-loop feedback simulations projected
population dynamics for all nine stocks forward
in time for $T = 32$ years, with annual simulated 
assessments, harvest decisions, and catch
removed from the population from 2017 - 2048. 
The following four steps summarise the 
closed-loop simulation procedure for each
projection year $t$:

1. Update stochastic population dynamics and
generate new catch $C_{s,p,t}$ from effort, 
and new observation data $I_{s,p,f,t}$ 
(table ref), aggregate obsservation data 
if using a data-pooled method;
2. Apply an assessment model to estimate the
spawning biomass for the following year 
$\hat{B}_{s,p,t+1}$;
3. Apply a harvest rate to generate a total
allowable catch: 
$TAC_{s,p,t+1} = U_{s,p} \cdot \hat{B}_{s,p,t+1}$;
4. Allocate effort to fully realise at least
one TAC in each stock area (tabref for Baranov}:
$E_{p,t+1} = \max \{ E ~|~ C_{s,p,t+1}(E) \leq TAC_{s,p,t+1} \}$,
where $C_{s,p,t+1}(E)$ is the catch of species
$s$ when effort $E$ is applied in area $p$ in year
$t+1$.

Each simulation consisting of $T = 32$ projection years was 
repeated 100 times to integrate over stochasticity
in recruitment and relative abundance observations. 

### Operating Model

The operating model (OM) was a multi-species,
multi-stock age- and sex-structured population 
dynamics model (Johnson and Cox, in prep). Population
life-history parameters for the operating
model were estimated by fitting a hierarchical 
age-structured model to data from the real 
DER complex.

Fishing mortality for individual stocks was 
driven by a single commercial trawl fishing
effort in each area. Commercial effort
was scaled to produce species-specific fishing 
mortality
\begin{equation}
F_{s,p,t} = q^{F}_{s,p} \cdot E_{p,t},
\end{equation}
where $F_{s,p,t}$ is the fishing mortality
rate applied to species $s$ in stock-area $p$
by fleet $f$ in year $t$, $q^{F}_{s,p}$
is the commercial catchabiluty coefficient
scaling trawl effort $E_{p,t}$ in area $p$ 
to fishing mortality [Johnson and Cox, in prep];
see Table X for the parameters used in our
simulations.

The above effort model allows us to derive
a multi-species maxmimum yield for the trawl
fishery in each area. Multi-species maximum yield
depends on individual species productivity and 
commercial trawl catchability, as well as the
relative catchabilities between all species
in the complex [@punt2011calculating; Johnson and 
Cox in prep]. We defined multi-species MSY for 
stock-area $p$ as
\begin{equation}
MSY_{MS,p} = \max_{E} Y_{MS} 
    \left( E, q^{F}_{1,p}, q^{F}_{2,p}, q^{F}_{3,p}, Q_p \right),
\end{equation}
where $E_p$ is the total commercial trawl 
fishing effort in area $p$, $q_{s,p}$ is the 
commerical trawl catchability coefficient scaling
fishing effort to fishing mortality for species $s$ 
in area $p$, and $Q_p$ is a matrix
of life-history parameters for all DER complex species
in area $p$. The function $Y_{MS}$
is the total multi-species yield in area $p$ as 
a function of fishing effort $E_p$, which is
defined as the sum of species-specific equilibrium
yields
\begin{equation}
Y_{MS,p} \left(E_p, q^{F}_{1,p}, q^{F}_{2,p}, q^{F}_{3,p}, Q_p \right)
 = \sum^3_{s=1} Y_{SS,s,p} (E_p, q_{s,p}, Q_{s,p} ),
\end{equation}
where $Q_{s,p}$ is the slice of matrix $Q_p$ 
containing life history paramteers for 
species $s$, and the function $Y_{SS,s,p}$ 
is the traditional single-species yield curve
but as a function of effort and not fishing
mortality.

The level of fishing effort at which the 
multi-species maximum yield $MSY_{MS,p}$ is 
achieved is defined as 
\begin{equation}
E_{MSY,p} = \argmax_{E} Y_{MS} 
    \left( E, q^{F}_{1,p}, q^{F}_{2,p}, q^{F}_{3,p}, Q_p \right),
\end{equation}
with the arguments as defined above. The
fishing effort level $E_{MSY,MS,p}$ has an associated
equilibrium biomass $B_{MSY,MS,s,p}$ and yield 
$MSY_{MS,s,p} = Y_{SS,s,p} (E_{MSY,MS,p}, q^{F}_{s,p}, Q_{s,p} )$ 
for each individual species, which may differ 
from the single-species $B_{MSY}$ and $MSY$
for each individual stock.

For simulated fishing in the projection time period,
we allocated maximum fishing effort to each area. 
Maximum effort was defined as the amount required to
fully utilise the TAC of at least one species, 
but never exceed any of the three species' TACs (the
method for determining TACs is explained below). 
We chose to use maximum effort over an effort dynamics
model because (i) it is simpler to implement and (ii) 
it is analogous to fully realising a single-species 
TACs in single-species closed loop simulation/MSE. We 
considered including an effort dynamics 
model to allocate a pool of effort over the three areas 
[@hilborn1987general; @walters1999multispecies] using an
economic model, but determined that this was
not necessary for determining the management performance 
of the assessment models that we are testing.
Furthermore, although the BC groundfish fishery balances
the utilisation of many more than three TACs in practice,
and avoids fully utilising TACs to guarantee access
to fishing grounds in the presence of non-target species,
we found that the maxmium effort model effectively 
simulated the TAC under-utilisations for the DER complex.


### Surplus production stock assessment models

At each time step $t$, the assessment models
were used to estimate an expected 
biomass estimate $\hat{B}_{t+1}$ for the following 
time step. 

At each time step $t$, simulated annual asssessments 
were used to estimate an expected future spawning 
biomass estimate $\hat{B}_{t+1}$ via a state-space 
Schaefer production model [@schaefer1957some; 
@punt2002evaluation]. We extended the
@johnson2018evaluating hierarchical state-space
model to allow all assessment complex configurations,
ranging from data-pooled single-stock assessments
with no hierarchical structure, to a full
hierarchical multi-species and multi-stock
assessment. We defined the state-space
Schaefer model in Template Model Builder 
[@kristensen2015tmb]. For hierarchical model formulations, 
we applied shrinkage priors to survey catchability 
and intrinsic growth rate. We further modified 
our original surplus production 
stock assessment model better approximate the
biomass-yield relationship underlying the 
age-/sex-structured operating model 
[@pella1969generalized; @winker2018jabba].

In total, we defined the five model configurations
listed below:

1. Total aggregation (1 stock) [**TA**];
2. Species Pooling (3 stocks, independent) [**SpePool**];
3. Spatial Pooling (3 species, independent) [**SpaPool**];
4. Single-stock (9 stocks, independent) [**SS**];
5. Hierarchical multi-stock (9 stocks, sharing info) [**HMS**];

where the number of management units is shown in 
parentheses, and the abbreviated AM label is
shown in bold in square brackets. Details
of the AM configurations are in the online
supplemental material.

### Data generation for AMs

Time series of catch and biomass indices
were generated for fitting the simulated
assessment models. Catch-per-unit-of-effort
(CPUE) indices were generated from the 
commercial fleets from 1976 - 1995 
(historical) and 1995 - 2016 (modern), 
and survey trawlable biomass indices were
generated for the Hecate Strait assemblage
survey from 1984 - 2002, and in the Synoptic
survey from 2003 - 2048. We outline the
biomass index data generation methods for 
stock specific AMs and data-pooled AMs below.

Biomass indices for individual stocks depended
on the nature of the index. Assemblage and
Synoptic Survey biomass indices were defined 
as trawlable biomass
\begin{equation}
I_{s,p,f,t} = q_{s,p,f} \cdot B_{s,p,f,t},
\end{equation}
where $q_{s,p,f}$ is the survey trawl
efficiency for species $s$ and
stock-area $p$, and $B_{s,p,f,t}$ is the 
biomass of species $s$ in stock-area $p$
vulnerable to survey $f$ in year $t$. Commercial
CPUE indices were defined as
\begin{equation}
I_{s,p,f,t} = \frac{C_{s,p,f,t}}{E_{p,f,t}},
\end{equation}
where $C_{s,p,f,t}$ was commercial landings
by fleet $f$ of species $s$ from area $p$ at time
$t$, and $E_{p,f,t}$ was commercial fishing
effort expened in area $p$ by fleet $f$ at
time $t$, with both catch and effort required
to be positive. 

The method for generating pooled data depended on the
data type. Catch data were pooled by summation, 
and the index data were pooled according
to the stock-specific definition above. For Assemblage 
and Synoptic survey biomass indices, pooled indices 
without observation error were defined as
\begin{align} 
I^{pooled}_{s,f,t}  & = \sum_{p} I(I_{s,p,f,t} > 0) \cdot q_{s,p,f} \cdot B_{s,p,f,t}, \\
I^{pooled}_{p,f,t}  & = \sum_{s} I(I_{s,p,f,t} > 0) \cdot q_{s,p,f} \cdot B_{s,p,f,t}, \\
I^{pooled}_{f,t}    & = \sum_{s,p} I(I_{s,p,f,t} > 0) \cdot q_{s,p,f} \cdot B_{s,p,f,t},
\end{align}
where $I^{pooled}_{s,f,t}$ is the spatially
pooled index for species $s$, $I^{pooled}_{p,f,t}$ 
is a species pooled index for area $p$, 
$I^{pooled}_{f,t}$ is the totally aggregated 
index, and $I(I_{s,p,f,t} > 0)$ is the indicator
function that takes value $1$ when the index
from fleet $f$ for species $s$ in stock area $p$
existed and 0 when it didn't (i.e. the survey
leg for fleet $f$ in area $p$ was running in year
$t$). For the historical and modern commercial 
trawl CPUE, we defined the pooled CPUE index
as
\begin{align} 
I^{pooled}_{s,f,t}  & = \frac{\sum_{p} C_{s,p,f,t}}{\sum_{p} E_{p,f,t} }, \\
I^{pooled}_{p,f,t}  & = \frac{\sum_{s} C_{s,p,f,t}}{ E_{p,f,t} }, \\
I^{pooled}_{f,t}    & = \frac{\sum_{s,p} C_{s,p,f,t}}{ \sum_{p} E_{p,f,t} },
\end{align}
where $C_{s,p,f,t}$ is catch, and $E_{p,f,t}$ is
commercial trawl effort, with subscripts as 
defined above.

### Target harvest rates and total allowable catch

Simulated harvest decision rules applied 
a constant target harvest rate to generate
total allowable catch (TAC) from 
assessment model projections of biomass. 
The proposed total allowable catch (TAC) was 
set as the the product
\begin{equation}
TAC'_{s,p,t+1} =  U_{s,p} \cdot \hat{B}_{s,p,t+1} \},
\end{equation}
where $U_{s,p}$ is the target harvest rate, and
$\hat{B}_{s,p,t+1}$ is the projected year $t+1$ 
biomass output from the assessment model, for
species $s$ in stock-area $p$. Target harvest 
rates were derived from the 
multi-species maximum yield relationship. For
individual stocks, we defined
\begin{equation}
U_{s,p} = \frac{MSY_{MS,s,p}}{B_{MSY,MS,s,p}},
\end{equation}
where $MSY_{MS,s,p}$ and $B_{MSY,MS,s,p}$ are 
the yield and spawning biomass, respectively, 
associated with $E_{MSY,MS,p}$ for species $s$
in area $p$. 

Pooled TACs were set analagously, 
with pooled target harvest rates applied to 
biomass projections from pooled assessments. For a
spatially pooled assessment of species $s$, 
we defined the spatially pooled target harvest 
rate as
\begin{equation}
U_{s} = \frac{\sum_p MSY_{MS,s,p}}{\sum_p B_{MSY,MS,s,p}},
\end{equation}
where the notation is as defined above. Species 
pooled harvest rates and total aggregation
harvest rates were defined similarly.

Pooled TACs were split within an area or across
spatial strata proportional to Synoptic trawl
survey indices for the individual stocks. For example, 
if the TAC for area $p$ is set by a species pooled
assessment, then the proposed TAC for species $s$ is defined as
\[
TAC'_{s,p,t+1} = \frac{\bar{I}_{s,p,2}}{\sum_{s'} \bar{I}_{s',p,2}} TAC_{p,t+1},
\]
where $\bar{I}_{s,p,2}$ is the 2-year running average
of individual biomass indices from the Synoptic
survey for species $s$ in area $p$. The 2-year average
is used to reduce the effect of observation errors on
the apportionment rule, and because the synoptic survey 
alternates the legs it runs each year, so some individual
stock indices are missing each year.

Final TACs were determined by comparing
the proposed TAC to the previous time-step's
TAC. Inter-annual increases in TAC were limited to
20\% for all individual stocks to create a 
slow-up/fast-down TAC dynamic, i.e.,
\begin{equation*}
TAC_{s,p,t+1} = \min \{ TAC'_{s,p,t+1},1.2 * TAC_{s,p,t}\},
\end{equation*}
where $TAC'_{s,p,t+1}$ is the proposed TAC determined
above, and $TAC_{s,p,t}$ is the previous year's
TAC. The limited increase reduces overfishing as 
a result of optimistic assessment errors, potentially 
requiring several years of increases to realise 
target harvest rates (i.e., slow-up). Conversely, 
no limit was applied to TAC reductions, so that steep 
declines in assessment biomass would lead to steep declines in
catch, reducing catch to near-zero levels (i.e.,
fast-down).



## Simulation experiments and performance

We ran a total of $20$ simulation experiments comprising
five assessment models and four operating model data 
scenarios. We integrated over the stochastic processess
by running 100 random replicates of each combination. To
eliminate the effect of random variation between combinations
of assessments and data scenarios, each simulation was 
initialised with the same set of 100 seeds. We ran extra 
replicates until the sample size of 100 was reached 
when AMs failed to converge in the closed loop simulations, 
the rate of which was variable among AMs and data scenarios. 
The operating model was run for two Dover sole generations
[32 years; @seber1997estimation], which had the longest 
generation time in the DER complex.

For all DER stocks, the main differences
between OM replicates were in simulated survey observation 
errors and recruitment process error deviations during
the projection period (2016 onwards). Operating model 
population dynamics and index data were identical among 
replicates for each stock during the operating model 
historical period. Until a few years before the end of 
the historical period, replicates used the same set 
of recruitment process errors and observation errors. 
Simulated log-normal observation and process errors in
the projection were randomly drawn with the same 
standard deviations as the errors used in the historical
period, and bias corrected so that asymptotic medians 
matched their expected values, i.e.,
\begin{align}
I_{s,p,f,t} &= q_{s,p,f} \cdot B_{s,p,f,t} \cdot \exp( \tau_{s,p,f} \cdot \delta_{s,p,f,t} - 0.5\tau^2_{s,p,f} ) \\
R_{s,p,t}   &= \overline{R}_{s,p,t} \cdot \cdot \exp( \sigma_{s,p} \cdot \epsilon_{s,p,t} - 0.5\sigma^2_{s,p} ) 
\end{align}
where $\tau_{s,p,f}$ is the log-normal observation error 
standard deviation, $\delta_{s,p,f,t}$ is the annual 
standardised observation error residual, $\overline{R}_{s,p,t}$ 
is the equilibrium recruitment from the Beverton-Holt
stock-recruitment curve, $\sigma_{s,p}$ is the recruitment
process error standard deviation, $\epsilon_{s,p,t}$ is the
annual standardised recruitment process error, and subscripts
$s,p,f,t$ are for species, stock, fleet and year, respectively.



### Operating model data quality scenarios

The four data scenarios tested assessment models
against different levels of data availability,
moving from data-rich to data-poor by removing
selected biomass index series from the full set:

1. **Comm1** Historical CPUE, Modern CPUE, Assemblage 
survey, Synoptic survey;
2. **Comm2** Modern CPUE, Assemblage survey, Synoptic survey;
3. **Comm3** Modern CPUE, Synoptic survey;
4. **Surv** Assemblage survey, Synoptic survey.

We avoided running a scenario that reduced to 
only the Synoptic survey, because the Assemblage 
survey only runs in the HSHG stock area, so
the **AS** scenario was effectively Synoptic 
only for the 6 stocks outside of the HSHG area.
Furthermore, we were interested in whether the survey data 
in HSHG would help improve management performance 
in the other two areas, as predicted in previous 
simulation experiments [@johnson2018evaluating].


### Omniscient manager simulations

We measured our MP performance against a simulated
omniscient manager of the fishery. An omniscient 
manager is aware of all the consequences of their 
actions, and is able to adapt the management to 
meet given objectives [@walters1998evaluation]. We found
that comparing to an omnisicient manager was preferable 
to using standard MSE metrics, such as probability of avoiding
limit depletion levels, as most stocks were in a healthy
state (i.e. above $B_{MSY}$) and limit depletion
levels are arbitrary.

We implemented the omniscient manager as an optimisation
of future fishing effort by area, with the objective
function defined as
\begin{equation}
\mathcal{O}  = \left[\sum_{s,p}
                   -\log(\bar{C}_{s,p,\cdot}) \right] + 
                    \mathcal{P}_{diff}(\sum_p E_{p,\cdot}) +
                    \mathcal{P}_{init}(\sum_p E_{p,2017}), 
\end{equation}
where the optimisation minimises $-\log \bar{C}_{s,p,\cdot}$ 
for each stock and species over the
projection period (equivalent to maximising catch). 
Penalty functions $\mathcal{P}$ were applied for (i) 
annual changes in total effort across all three 
areas being above 20% ($\mathcal{P}_{diff}$) to match
the TAC smoother in stochastic experiments, and (ii) 
differences greater than 10% between the last 
year of historical effort and the first year 
$2017$ of simulated effort ($\mathcal{P}_{init}$),
we describe the penalty functions in detail in 
supplementary material. Details of the penalty
functions are supplied in the supplemental material.

We ran the omniscient manager simulation for every random
seed that was used in the stochcastic MP simulations. By doing so, 
we assured that an omniscient manager simulation was available
for every set of observation and process errors a stochastic MP 
was exposed to. Each replicate was run for 80 years to reduce
the effect of transient dynamics at the beginning of the 
projection, and any end effects from the end of the projection.


### Performance metrics


#### Cumulative loss and average rankings
We measured AM performance under stochastic
simulations by comparing the realised catch 
and biomass trajectories to their respective
optimal solutions obtained via the omniscient
manager. For each stochastic trajectory, the total
relative and absolute loss of catch and biomass
was calculated as [@walters1998evaluation]:
\begin{align}
L_{abs,s,p} &= \sum_{t = T_1}^{T_2} \vert X_{s,p,t,sim} - X_{s,p,t,omni} \vert,
\end{align}
where the $X_{s,p,t,\cdot}$ values are either catch 
or spawning biomass series for species $s$ and stock $p$ 
from stochastic simulations ($sim$) or the omniscient 
manager simulation ($omni$) simulation. When repeated 
over all random seed values, the loss functions generate 
a distribution of total biomass and catch loss, which 
we compare for performance of each stochastic MP. Total 
loss was calcualted for the ten projection year 
period $T_1 = 2026$ to $T_2 = 2035$, chosen in the middle 
of the projection period because loss in the 
earlier time periods was optimistically biased by the TAC
smoother.

Cumulative absolute loss was used to calculate the relative
rank of each AM for each species/stock/OM scenario 
combination (lower loss ranked higher). We then calculated 
the average, minimum, and maximum rank of each AM 
across species and stocks to determine the general 
performance under each OM scenario.

#### Biomass/catch trade-offs

We compared the catch/biomass tradeoffs implied by
each AM under a given scenario. For each
AM and OM combination, we calculated the median 
catch relative to the multi-species maximum yield 
$C_{s,p,t}/MSY_{MS,s,p}$, and median biomass relative
to the biomass level at which multi-species maximum
yield is achieved $B_{s,p,t} / B_{MSY,MS,s,p,t}$. Medians
of each quantity were taken over all replicates, and 
the time period $T_1 \leq t \leq T_2$. 



## Sensitivity runs

Given the need for informative prior distributions to 
stabilise the assessment model behaviour in simulations, 
we conducted sensitivity analyses. Sensitivity
analyses focused on the prior distributions applied to
the assessment model estimates of $B_{MSY}$ and $U_{MSY}$
parameters in all AM structures, as well as the 
hierarchical prior distribution standard deviations 
for the $U_{MSY}$ and Synoptic catchability $q_{Syn}$
parameters under the hierarchical multi-stock AM structure. 
We also expected the technical interactions between species
to have an effect on the outcomes, so devised a scenario where
we randomly switched commercial trawl catchability scalars
$q^{F}_{s,p}$ within an area. The factors for sensitivity 
analyses are summarised in table 3.

1. Bmsy/Umsy prior CV = 0.1, 0.5, 1.0
2. HMS shrinkage prior SDs 0.1, 0.2, 0.5
3. Switching commercial catchabilities randomly within an area

Sensitivity run performance was measured via convergence 
rate and total biomass and catch loss. To reduce
computational overhead, we only ran sensitivity 
analyses for the Comm1 and Surv scenarios, and only
for 50 replicates.

