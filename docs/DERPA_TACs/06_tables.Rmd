# Tables

```{r loadInfoFiles-tables, echo = FALSE, include = FALSE, warning = FALSE}
# Now read in all the info files
info.df <- readBatchInfo(batchDir = projDir) %>%
      mutate( blobPath = "", 
              perfTabPath = "", 
              lossBlobPath = "" )
# Update paths for each RData file and perf 
# table file
for( simIdx in 1:nrow(info.df))
{
  simLabel <- info.df$simLabel[simIdx]

  info.df$blobPath[simIdx]     <- file.path(projDir, simLabel, paste(simLabel,".RData",sep = "") )
  info.df$perfTabPath[simIdx]  <- file.path(projDir, simLabel, "simPerfStats.csv" )
  info.df$lossBlobPath[simIdx] <- file.path(projDir, simLabel, "loss.RData" )
}


```

```{r loadOmni-tables, echo = FALSE, include = FALSE, warning = FALSE}
omniInfo <- info.df %>% 
              filter( grepl( params$baseline, simLabel) )

# load performance table
omniPerfTab <- read.csv(omniInfo$perfTabPath)


```

```{r loadHistoryFit, echo = FALSE, include = FALSE, warning = FALSE}
fitReport <- .loadFit(params$history)

nS <- fitReport$repOpt$nS
nP <- fitReport$repOpt$nP
nG <- fitReport$repOpt$nG

```



```{r tableCaps, echo = FALSE, include = FALSE, warning = FALSE }
dataSourceCap <- "Fishery dependent and independent indices of 
biomass available for stock assessments of DER complex species."

stockStatusTabCap <- "Unfished biomas, single-species MSY based 
reference points $B_{MSY,SS}$ and $U_{MSY,SS}$, stock status as absolute
biomass in 2016, depletion relative to unfished, and single-species
$B_{MSY,SS}$, and commercial trawl catchability scalar $q^{F}$ for all 
DER complex stocks in 2016."

expDesignTableCap <- "Summary of OM and AM factors in the experimental
design for the simulation experiments."

sensRunTableCap   <- "Summary of sensitivity analyses, showing
the total number of experiments, the factor being varied, the
levels of that factor, and the data scenarios and AMs included
in the analysis."

omniPerfTabCap <- "Biomass and catch summaries for all nine DER
complex management units under the omniscient manager simulations."

AM_relErrorsTabCap <- "Bias and precision metrics (MRE, MARE) for assessment 
model estimates under the Comm1 scenario. Metrics were calculated for 
spawning stock biomass $B_t$, assessment model 
$B_{MSY}$, and assessment model $U_{MSY}$. Operating model $B_{MSY}$
for pooled data AMs was defined by pooling optimal biomass for
component stock, and operating model $U_{MSY}$ was found by pooling 
single-species maximum yield, and taking the ratio of pooled yield
and biomass."

lossRankTabCap <- "Summary of rankings of each AM in each scenario 
under relative and absolute catch and biomasss loss. Each column shows
the rank averaged over all 9 DER complex stocks, with the maximum
and minumum shown in parentheses."



```


```{r dataSources, echo = FALSE, warning = FALSE}

dataSourcesTable <- tibble::tribble( 
~Series,             ~Extent,           ~Description,
"comm.hist",         "1976 - 1995",     "Historical period commercial CPUE",
"comm.mod",          "1996 - 2016",     "Modern period commercial CPUE",
"HSAss",             "1984 - 2002",     "Hecate Strait Assemblage trawl survey biomass index, biennial",
"Syn",               "2003 - 2016",     "Multi-species Synoptic trawl survey biomass index, biennial",
)

kable(  dataSourcesTable, escape = FALSE,
        booktabs = TRUE,
        caption = dataSourceCap,
        align = rep("l",ncol(dataSourcesTable))) %>%
  kable_styling(latex_options = c("striped", "hold_position","scale_down"),
                bootstrap_options = c("striped", "hover"))

```

\clearpage


```{r stockStatusTab, echo = FALSE }
stockStatusColNames <- c( "Species",
                          "Stock",
                          "B0",
                          "Bmsy",
                          "Umsy",
                          "$B_{2016}$",
                          "$B_{2016}/B_{MSY}$",
                          "qF" )

stockStatusTab <- matrix( NA, nrow = 9, ncol = length(stockStatusColNames) )
colnames(stockStatusTab) <- stockStatusColNames
stockStatusTab <- as.data.frame(stockStatusTab)

specLabs  <- fitReport$species
stockLabs <- fitReport$stocks

B0_sp     <- fitReport$repOpt$B0_sp
refPts    <- fitReport$repOpt$refPts$FmsyRefPts

# spawning biomass series
SB_spt    <- fitReport$repOpt$SB_spt
D_sp2016  <- SB_spt[,,"2016"] / refPts$BeqFmsy_sp

# Pull qF
.loadSim( 2, folder = params$groupFolder)
qF_sp      <- blob$om$qF_ispft[1,,,2,blob$om$tMP]

for( s in 1:nS )
  for( p in 1:nP )
  {
    rIdx <- p + (s-1)*nP

    stockStatusTab[rIdx,"Species"]    <- specLabs[s]
    stockStatusTab[rIdx,"Stock"]      <- stockLabs[p]

    # Pull reference points, B0
    stockStatusTab[rIdx,"B0"]         <- round(B0_sp[s,p],2)
    stockStatusTab[rIdx,"Bmsy"]       <- round(refPts$BeqFmsy_sp[s,p],2)
    stockStatusTab[rIdx,"Umsy"]       <- round(refPts$Umsy_sp[s,p],2)
    stockStatusTab[rIdx,"$B_{2016}$"] <- round(SB_spt[s,p,"2016"],2)
    stockStatusTab[rIdx,"$B_{2016}/B_{MSY}$"] <- round(D_sp2016[s,p],2)
    stockStatusTab[rIdx,"qF"]         <- round(qF_sp[s,p],3)

  }

colnames(stockStatusTab) <- c(  "Species",
                                "Stock",
                                "$B_0$",
                                "$B_{MSY,SS}$",
                                "$U_{MSY,SS}$",
                                "$B_{2016}$",
                                "$B_{2016}/B_{MSY}$",
                                "$q^{F}$")

stockStatusTab <- stockStatusTab[,-1]

kable(  stockStatusTab, escape = FALSE, 
        caption = stockStatusTabCap, booktabs = T,
        align = rep("c",ncol(stockStatusTab))) %>%
  kable_styling(latex_options = c("striped", "scale_down","hold_position"),
                bootstrap_options = c("striped", "hover")) %>%
  pack_rows( "Dover sole",1,3 ) %>%
  pack_rows( "English sole",4,6 ) %>%
  pack_rows( "Rock sole",7,9 ) %>%
  add_header_above(c(" " = 1, "Single-species Reference Points" = 3, "Stock Status" = 2, "Comm. Catchability" = 1 ))

```


\clearpage

```{r expDesignTab, echo = FALSE, warning = FALSE}

options(knitr.kable.NA = "")

expFactorLabelsTable <- tibble::tribble( 
  ~Factor,     ~Description,
  "Comm1",      "Historical and modern commercial indices,",
  NA,           "with Assemblage and Synoptic survey indices",
  "Comm2",      "Modern commercial index only, with",
  NA,           "Assemblage and Synoptic survey indices",
  "Comm2",      "Modern commercial index only, with",
  NA,           "Synoptic survey index only",
  "Surv",       "Assemblage and Synoptic survey indices, with",
  NA,           "no commercial indices",
  "TA",         "One assessment model fit to totally aggregated data",
  NA,NA,
  "SpaPool",    "Three independent assessments fit to spatially pooled data",
  NA,           "for each DER complex species",
  "SpePool",    "Three independent assessments fit to species pooled data",
  NA,           "in each DER complex stock area",
  "HMS",        "One joint hierarchical multi-stock assessment of",
  NA,           "all nine DER complex stocks",
  "SS",         "Nine independent single-stock assessments of",
  NA,           "each DER complex stocks",)

colnames(expFactorLabelsTable) <- c("Level","Description")

kable(  expFactorLabelsTable, escape = FALSE,
        booktabs = TRUE,
        caption = expDesignTableCap,
        align = rep("l",ncol(expFactorLabelsTable))) %>%
  kable_styling(latex_options = c("striped", "hold_position","scale_down"),
                bootstrap_options = c("striped", "hover")) %>%
  pack_rows("OM Data Scenario", 1, 8) %>%
  pack_rows("AM Structure", 9, 18)


```

\clearpage{}

```{r sensRunsTable, echo = FALSE}
sensRunTable <- tibble::tribble( 
    ~N,     ~Factor,                ~Levels,            ~Scenarios,     ~AMs,
    10,     "$q^{F}$",              "Randomly switched","Comm1, Surv",  "TA, SpaPool, SpePool, HMS, SS",
    30,     "$B_{MSY}$ prior SD",   "$0.1, 0.5, 1.0$",  "Comm1, Surv",  "TA, SpaPool, SpePool, HMS, SS",
    30,     "$U_{MSY}$ prior SD",   "$0.1, 0.5, 1.0$",  "Comm1, Surv",  "TA, SpaPool, SpePool, HMS, SS",
    6,      "$\\tau_q$, $\\sigma_U$", "$0.1, 0.2, .5$",   "Comm1, Surv",  "HMS", )

kable(  sensRunTable, escape = FALSE,
        booktabs = TRUE,
        caption = sensRunTableCap,
        align = rep("l",ncol(sensRunTable))) %>%
  kable_styling(latex_options = c("striped", "hold_position","scale_down"),
                bootstrap_options = c("striped", "hover")) 
```

\blandscape

```{r omniPerfTab, echo = FALSE, warning = FALSE}
omniPerfTab <- omniPerfTab %>%
                dplyr::select(  Species = species,
                                Stock = stock, 
                                "pBtGt.4Bmsy",
                                "PBtGt.8Bmsy",
                                pBtGtBmsy,
                                pCtGtMSY,
                                pFtGtFmsy,
                                avgCatch,
                                AAV )

colnames(omniPerfTab) <- c( "Species",
                            "Stock",
                            "$P(B_{2026:2035} > .4B_{MSY,SS})$",
                            "$P(B_{2026:2035} > .8B_{MSY,SS})$",
                            "$P(B_{2026:2035} > B_{MSY,SS})$",
                            "$P(C_{2026:2035} > MSY_{SS})$",
                            "$P(F_{2026:2035} > F_{MSY,SS})$",
                            "$\\overline{C}_{2026:2035}$",
                            "$AAV$")


omniPerfTab <- omniPerfTab[,-1]

kable(  omniPerfTab, escape = FALSE, 
        caption = omniPerfTabCap, booktabs = T,
        align = rep("c",ncol(omniPerfTab))) %>%
  kable_styling(latex_options = c("striped", "scale_down","hold_position"),
                bootstrap_options = c("striped", "hover")) %>%
  pack_rows( "Dover sole",1,3 ) %>%
  pack_rows( "English sole",4,6 ) %>%
  pack_rows( "Rock sole",7,9 ) %>%
  add_header_above( c(" " = 1,
                      "Probability of being overfished" = 3,
                      "Probability of overfishing" = 2,
                      "Mean catch" = 1,
                      "Catch Variation" = 1 ) )

```

\elandscape

\clearpage

```{r AMmareTable, echo = FALSE }

mareTable <- read.csv(here::here("Outputs",params$groupFolder,"mareTable.csv"))

round2 <- function(x)
{
  x <- round(x,2)
  x
}

# Replace Scenario names and AM names
AMlabs <- c(  "singleStock_omF_MSrefPts"= "SS",
              "hierMultiStock_omF_MSrefPts"= "HMS",
              "speciesPooling_omF_MSrefPts"= "SpePool",
              "spatialPooling_omF_MSrefPts"= "SpaPool",
              "totalAgg_omF_MSrefPts"= "TA")
scenLabs <- c(  "DERfit_HcMcAsSsIdx" = "Comm1",
                "DERfit_McAsSsIdx" = "Comm2",
                "DERfit_McSsIdx" = "Comm3",
                "DERfit_AsSsIdx"  = "Surv")

mareTable <- mareTable %>%
                  mutate( Scenario = stringr::str_replace_all(Scenario, scenLabs),
                          AM = str_replace_all(AM, AMlabs) ) %>%
                  dplyr::select( Scenario, AM, Species, Stock, MARE_Bt, MRE_Bt, MARE_Bmsy, MRE_Bmsy, MARE_Umsy, MRE_Umsy ) %>%
                  filter( Scenario == "comm2" ) %>%
                  arrange(Scenario, AM, Species) %>%
                  mutate_if(is.numeric, round2 )


kable(  mareTable, escape = FALSE, 
        caption = AM_relErrorsTabCap, booktabs = T,
        align = rep("c",ncol(mareTable))) %>%
  kable_styling(latex_options = c("striped", "scale_down","hold_position"),
                bootstrap_options = c("striped", "hover")) 

```

\clearpage

```{r lossRankTable, echo = FALSE, warning =FALSE}
lossRankTable <- makeLossRankTable( groupFolder = params$groupFolder,
                                    prefix = "parBat",
                                    period = 73:82,
                                    clearBadReps = TRUE,
                                    minSampSize = 10 ) %>%
                    ungroup()

# Replace Scenario names and AM names
AMlabs <- c(  "singleStock"= "SS",
              "hierMultiStock"= "HMS",
              "speciesPooling"= "SpePool",
              "spatialPooling"= "SpaPool",
              "totalAgg" = "TA")
scenLabs <- c(  "DERfit_HcMcAsSsIdx" = "Comm1",
                "DERfit_McAsSsIdx" = "Comm2",
                "DERfit_McSsIdx" = "Comm3",
                "DERfit_AsSsIdx"  = "Surv")

lossRankTable <- lossRankTable %>%
                  mutate( Scenario = stringr::str_replace_all(Scenario, scenLabs),
                          AM = str_replace_all(AM, AMlabs) ) %>%
                  dplyr::select( Scenario, AM, absCrank, absBrank ) %>%
                  arrange(Scenario)


colnames(lossRankTable) <- c( "Scenario","AM",
                              "Catch Loss Rank", 
                              "Biomass Loss Rank")

kable(  lossRankTable, escape = FALSE, 
        caption = lossRankTabCap, booktabs = T,
        align = rep("c",ncol(lossRankTable))) %>%
  kable_styling(latex_options = c("striped", "scale_down","hold_position"),
                bootstrap_options = c("striped", "hover")) %>%
  add_header_above( c(" " = 2,
                      "Rank Distributions" = 2 ) )
```

\clearpage